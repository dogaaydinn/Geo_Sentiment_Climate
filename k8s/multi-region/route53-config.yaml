# AWS Route53 Configuration for Global Load Balancing
# Provides geo-routing and failover for multi-region deployment

# Route53 Hosted Zone (managed via Terraform/CloudFormation)
# Domain: geo-climate.com

# Health Checks for each region:
# - US-EAST-1: https://api-us-east-1.geo-climate.com/health
# - US-WEST-2: https://api-us-west-2.geo-climate.com/health
# - EU-WEST-1: https://api-eu-west-1.geo-climate.com/health
# - AP-SOUTHEAST-1: https://api-ap-southeast-1.geo-climate.com/health

# DNS Records:
# 1. Geolocation Routing
#    - api.geo-climate.com (North America) -> us-east-1
#    - api.geo-climate.com (Europe) -> eu-west-1
#    - api.geo-climate.com (Asia) -> ap-southeast-1
#    - api.geo-climate.com (Default) -> us-east-1

# 2. Weighted Routing (for gradual traffic shifting)
#    - 70% -> us-east-1
#    - 15% -> us-west-2
#    - 10% -> eu-west-1
#    - 5% -> ap-southeast-1

# 3. Failover Routing
#    - Primary: us-east-1
#    - Secondary: us-west-2

# Terraform Configuration Example:
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: route53-terraform-config
  namespace: geo-climate
data:
  main.tf: |
    # Route53 Hosted Zone
    resource "aws_route53_zone" "main" {
      name = "geo-climate.com"

      tags = {
        Environment = "production"
        ManagedBy   = "terraform"
      }
    }

    # Health Checks
    resource "aws_route53_health_check" "us_east_1" {
      fqdn              = "api-us-east-1.geo-climate.com"
      port              = 443
      type              = "HTTPS"
      resource_path     = "/health"
      failure_threshold = 3
      request_interval  = 30

      tags = {
        Name   = "geo-climate-us-east-1"
        Region = "us-east-1"
      }
    }

    # Geolocation Routing - North America
    resource "aws_route53_record" "api_na" {
      zone_id = aws_route53_zone.main.zone_id
      name    = "api.geo-climate.com"
      type    = "A"

      geolocation_routing_policy {
        continent = "NA"
      }

      alias {
        name                   = aws_lb.us_east_1.dns_name
        zone_id                = aws_lb.us_east_1.zone_id
        evaluate_target_health = true
      }

      health_check_id = aws_route53_health_check.us_east_1.id
      set_identifier  = "North-America"
    }

    # CloudFront Distribution for CDN
    resource "aws_cloudfront_distribution" "main" {
      enabled         = true
      is_ipv6_enabled = true
      comment         = "Geo Climate API CDN"
      price_class     = "PriceClass_All"

      origin {
        domain_name = "api.geo-climate.com"
        origin_id   = "geo-climate-origin"

        custom_origin_config {
          http_port              = 80
          https_port             = 443
          origin_protocol_policy = "https-only"
          origin_ssl_protocols   = ["TLSv1.2"]
        }
      }

      default_cache_behavior {
        allowed_methods        = ["DELETE", "GET", "HEAD", "OPTIONS", "PATCH", "POST", "PUT"]
        cached_methods         = ["GET", "HEAD"]
        target_origin_id       = "geo-climate-origin"
        viewer_protocol_policy = "redirect-to-https"
        compress               = true
        min_ttl                = 0
        default_ttl            = 300
        max_ttl                = 3600

        forwarded_values {
          query_string = true
          headers      = ["Authorization", "X-API-Key"]

          cookies {
            forward = "none"
          }
        }
      }

      restrictions {
        geo_restriction {
          restriction_type = "none"
        }
      }

      viewer_certificate {
        acm_certificate_arn      = aws_acm_certificate.main.arn
        ssl_support_method       = "sni-only"
        minimum_protocol_version = "TLSv1.2_2021"
      }

      tags = {
        Environment = "production"
        Service     = "geo-climate"
      }
    }
