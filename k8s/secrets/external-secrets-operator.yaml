# External Secrets Operator Configuration
# Provides integration with external secret management systems
#
# Supported backends:
# - AWS Secrets Manager
# - Azure Key Vault
# - Google Secret Manager
# - HashiCorp Vault
# - 1Password
# - Doppler
#
# Installation:
#   helm repo add external-secrets https://charts.external-secrets.io
#   helm install external-secrets external-secrets/external-secrets \
#     --namespace external-secrets-system \
#     --create-namespace
#
# Usage:
#   kubectl apply -f k8s/secrets/external-secrets-operator.yaml

---
# ============================================================================
# AWS Secrets Manager Integration
# ============================================================================

apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: aws-secrets-manager
  namespace: geo-climate
spec:
  provider:
    aws:
      service: SecretsManager
      region: us-east-1

      # Option 1: Use IAM Role (IRSA - recommended for EKS)
      auth:
        jwt:
          serviceAccountRef:
            name: geo-climate-api

      # Option 2: Use Access Key (not recommended for production)
      # auth:
      #   secretRef:
      #     accessKeyIDSecretRef:
      #       name: aws-credentials
      #       key: access-key-id
      #     secretAccessKeySecretRef:
      #       name: aws-credentials
      #       key: secret-access-key

---
# External Secret for Database Credentials (AWS)
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: postgres-external-secret
  namespace: geo-climate
spec:
  refreshInterval: 1h  # Refresh every hour

  secretStoreRef:
    name: aws-secrets-manager
    kind: SecretStore

  target:
    name: postgres-secrets  # Kubernetes secret to create
    creationPolicy: Owner
    template:
      engineVersion: v2
      data:
        POSTGRES_USER: "{{ .postgres_user }}"
        POSTGRES_PASSWORD: "{{ .postgres_password }}"
        POSTGRES_DB: "{{ .postgres_db }}"
        DATABASE_URL: "postgresql://{{ .postgres_user }}:{{ .postgres_password }}@postgres:5432/{{ .postgres_db }}"

  data:
    - secretKey: postgres_user
      remoteRef:
        key: geo-climate/production/database  # AWS Secrets Manager secret name
        property: username

    - secretKey: postgres_password
      remoteRef:
        key: geo-climate/production/database
        property: password

    - secretKey: postgres_db
      remoteRef:
        key: geo-climate/production/database
        property: database

---
# External Secret for Application Secrets (AWS)
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: app-external-secret
  namespace: geo-climate
spec:
  refreshInterval: 1h

  secretStoreRef:
    name: aws-secrets-manager
    kind: SecretStore

  target:
    name: geo-climate-secrets
    creationPolicy: Owner

  data:
    - secretKey: JWT_SECRET_KEY
      remoteRef:
        key: geo-climate/production/app
        property: jwt_secret_key

    - secretKey: JWT_REFRESH_SECRET_KEY
      remoteRef:
        key: geo-climate/production/app
        property: jwt_refresh_secret_key

    - secretKey: ENCRYPTION_KEY
      remoteRef:
        key: geo-climate/production/app
        property: encryption_key

---
# ============================================================================
# HashiCorp Vault Integration
# ============================================================================

apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: vault-backend
  namespace: geo-climate
spec:
  provider:
    vault:
      server: "https://vault.example.com:8200"
      path: "secret"  # KV v2 path
      version: "v2"

      # Kubernetes auth method (recommended)
      auth:
        kubernetes:
          mountPath: "kubernetes"
          role: "geo-climate"
          serviceAccountRef:
            name: geo-climate-api

      # AppRole auth (alternative)
      # auth:
      #   appRole:
      #     path: "approle"
      #     roleId: "role-id"
      #     secretRef:
      #       name: vault-approle
      #       key: secret-id

---
# External Secret for Vault
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: vault-external-secret
  namespace: geo-climate
spec:
  refreshInterval: 15m  # More frequent for Vault

  secretStoreRef:
    name: vault-backend
    kind: SecretStore

  target:
    name: geo-climate-secrets
    creationPolicy: Owner

  data:
    - secretKey: JWT_SECRET_KEY
      remoteRef:
        key: geo-climate/production
        property: jwt_secret_key

    - secretKey: DATABASE_URL
      remoteRef:
        key: geo-climate/production
        property: database_url

---
# ============================================================================
# Google Secret Manager Integration
# ============================================================================

apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: gcpsm-secret-store
  namespace: geo-climate
spec:
  provider:
    gcpsm:
      projectID: "your-gcp-project-id"

      # Workload Identity (recommended for GKE)
      auth:
        workloadIdentity:
          clusterLocation: us-central1
          clusterName: geo-climate-prod
          serviceAccountRef:
            name: geo-climate-api

---
# External Secret for GCP Secret Manager
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: gcp-external-secret
  namespace: geo-climate
spec:
  refreshInterval: 1h

  secretStoreRef:
    name: gcpsm-secret-store
    kind: SecretStore

  target:
    name: geo-climate-secrets
    creationPolicy: Owner

  data:
    - secretKey: JWT_SECRET_KEY
      remoteRef:
        key: geo-climate-jwt-secret

    - secretKey: DATABASE_PASSWORD
      remoteRef:
        key: geo-climate-db-password
        version: latest  # Use specific version for immutability

---
# ============================================================================
# Azure Key Vault Integration
# ============================================================================

apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: azure-keyvault
  namespace: geo-climate
spec:
  provider:
    azurekv:
      vaultUrl: "https://geo-climate-kv.vault.azure.net"

      # Managed Identity (recommended for AKS)
      authType: ManagedIdentity

      # Service Principal (alternative)
      # authType: ServicePrincipal
      # authSecretRef:
      #   clientId:
      #     name: azure-sp
      #     key: client-id
      #   clientSecret:
      #     name: azure-sp
      #     key: client-secret
      # tenantId: "your-tenant-id"

---
# External Secret for Azure Key Vault
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: azure-external-secret
  namespace: geo-climate
spec:
  refreshInterval: 1h

  secretStoreRef:
    name: azure-keyvault
    kind: SecretStore

  target:
    name: geo-climate-secrets
    creationPolicy: Owner

  data:
    - secretKey: JWT_SECRET_KEY
      remoteRef:
        key: geo-climate-jwt-secret

    - secretKey: DATABASE_PASSWORD
      remoteRef:
        key: geo-climate-db-password

---
# ============================================================================
# ClusterSecretStore (cluster-wide)
# ============================================================================

apiVersion: external-secrets.io/v1beta1
kind: ClusterSecretStore
metadata:
  name: cluster-secret-store
spec:
  provider:
    aws:
      service: SecretsManager
      region: us-east-1
      auth:
        jwt:
          serviceAccountRef:
            name: external-secrets
            namespace: external-secrets-system

---
# ============================================================================
# Secret Rotation Configuration
# ============================================================================

# PushSecret - Push Kubernetes secrets to external stores
apiVersion: external-secrets.io/v1alpha1
kind: PushSecret
metadata:
  name: pushsecret-example
  namespace: geo-climate
spec:
  refreshInterval: 10m

  secretStoreRefs:
    - name: aws-secrets-manager
      kind: SecretStore

  selector:
    secret:
      name: postgres-secrets

  data:
    - match:
        secretKey: POSTGRES_PASSWORD
        remoteRef:
          remoteKey: geo-climate/production/database
          property: password

---
# ============================================================================
# SETUP SCRIPTS
# ============================================================================
#
# AWS Secrets Manager Setup:
# --------------------------
#
# 1. Create secrets in AWS:
#    aws secretsmanager create-secret \
#      --name geo-climate/production/database \
#      --secret-string '{
#        "username": "geo_climate",
#        "password": "'$(openssl rand -base64 32)'",
#        "database": "geo_climate_prod"
#      }'
#
#    aws secretsmanager create-secret \
#      --name geo-climate/production/app \
#      --secret-string '{
#        "jwt_secret_key": "'$(openssl rand -hex 64)'",
#        "jwt_refresh_secret_key": "'$(openssl rand -hex 64)'",
#        "encryption_key": "'$(openssl rand -base64 32)'"
#      }'
#
# 2. Create IAM policy for EKS pod:
#    cat > geo-climate-secrets-policy.json <<EOF
#    {
#      "Version": "2012-10-17",
#      "Statement": [
#        {
#          "Effect": "Allow",
#          "Action": [
#            "secretsmanager:GetSecretValue",
#            "secretsmanager:DescribeSecret"
#          ],
#          "Resource": "arn:aws:secretsmanager:us-east-1:*:secret:geo-climate/*"
#        }
#      ]
#    }
#    EOF
#
#    aws iam create-policy \
#      --policy-name GeoClimateSecretsPolicy \
#      --policy-document file://geo-climate-secrets-policy.json
#
# 3. Create IAM role for service account (IRSA):
#    eksctl create iamserviceaccount \
#      --name geo-climate-api \
#      --namespace geo-climate \
#      --cluster geo-climate-prod \
#      --attach-policy-arn arn:aws:iam::ACCOUNT_ID:policy/GeoClimateSecretsPolicy \
#      --approve
#
#
# HashiCorp Vault Setup:
# ----------------------
#
# 1. Enable Kubernetes auth:
#    vault auth enable kubernetes
#
# 2. Configure Kubernetes auth:
#    vault write auth/kubernetes/config \
#      kubernetes_host="https://kubernetes.default.svc:443" \
#      kubernetes_ca_cert=@/var/run/secrets/kubernetes.io/serviceaccount/ca.crt \
#      token_reviewer_jwt=@/var/run/secrets/kubernetes.io/serviceaccount/token
#
# 3. Create policy:
#    vault policy write geo-climate - <<EOF
#    path "secret/data/geo-climate/*" {
#      capabilities = ["read"]
#    }
#    EOF
#
# 4. Create role:
#    vault write auth/kubernetes/role/geo-climate \
#      bound_service_account_names=geo-climate-api \
#      bound_service_account_namespaces=geo-climate \
#      policies=geo-climate \
#      ttl=24h
#
# 5. Store secrets:
#    vault kv put secret/geo-climate/production \
#      jwt_secret_key="$(openssl rand -hex 64)" \
#      database_url="postgresql://..."
#
#
# Google Secret Manager Setup:
# ----------------------------
#
# 1. Enable API:
#    gcloud services enable secretmanager.googleapis.com
#
# 2. Create secrets:
#    echo -n "$(openssl rand -hex 64)" | \
#      gcloud secrets create geo-climate-jwt-secret --data-file=-
#
#    echo -n "$(openssl rand -base64 32)" | \
#      gcloud secrets create geo-climate-db-password --data-file=-
#
# 3. Grant access to GKE service account:
#    gcloud secrets add-iam-policy-binding geo-climate-jwt-secret \
#      --member="serviceAccount:geo-climate@PROJECT_ID.iam.gserviceaccount.com" \
#      --role="roles/secretmanager.secretAccessor"
#
#
# Azure Key Vault Setup:
# ----------------------
#
# 1. Create Key Vault:
#    az keyvault create \
#      --name geo-climate-kv \
#      --resource-group geo-climate-rg \
#      --location eastus
#
# 2. Create secrets:
#    az keyvault secret set \
#      --vault-name geo-climate-kv \
#      --name geo-climate-jwt-secret \
#      --value "$(openssl rand -hex 64)"
#
#    az keyvault secret set \
#      --vault-name geo-climate-kv \
#      --name geo-climate-db-password \
#      --value "$(openssl rand -base64 32)"
#
# 3. Grant access to AKS managed identity:
#    az keyvault set-policy \
#      --name geo-climate-kv \
#      --object-id <managed-identity-object-id> \
#      --secret-permissions get list
#
# ============================================================================
